{"version":3,"sources":["../src/i18n_service.js"],"names":["I18nClient","translationStore","supportedLocales","defaultLocale","stateDict","useFallbackForMissing","isEditMode","editTranslationAction","console","log","translationId","shouldShowKeysAsFallback","changeCallbacks","Error","keyOrArrayOfKeys","key","has","k","args","tKey","keyOrNamespace","props","showKeyForMissing","disableEditorBypass","nullKeyValue","translation","translate","getLocale","getFallbackLocale","undefined","hasObject","doc","propertyKey","path","locale","t","fallbackLocale","indexOf","supports","split","lang","set","forEach","callback","get","push"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;;;IAQMA,U;AACJ,4BA0BG;AAAA,QAzBDC,gBAyBC,QAzBDA,gBAyBC;AAAA,qCAxBDC,gBAwBC;AAAA,QAxBDA,gBAwBC,yCAxBkB,CAAC,IAAD,CAwBlB;AAAA,kCAvBDC,aAuBC;AAAA,QAvBDA,aAuBC,sCAvBe,IAuBf;AAAA,QAtBDC,SAsBC,QAtBDA,SAsBC;AAAA,qCAnBDC,qBAmBC;AAAA,QAnBDA,qBAmBC,yCAnBuB,IAmBvB;AAAA,+BAZDC,UAYC;AAAA,QAZDA,UAYC,mCAZY;AAAA,aAAM,KAAN;AAAA,KAYZ;AAAA,qCAXDC,qBAWC;AAAA,QAXDA,qBAWC,yCAXuB,yBAAiB;AACvC;AACAC,cAAQC,GAAR,CAAY,iDAAZ;AACAD,cAAQC,GAAR,CAAY,yCAAZ;AACAD,cAAQC,GAAR,CAAY,8BAAZ;AACAD,cAAQC,GAAR,iBAA0BC,aAA1B;AACD,KAKA;AAAA,qCADDC,wBACC;AAAA,QADDA,wBACC,yCAD0B;AAAA,aAAM,KAAN;AAAA,KAC1B;AAAA;;AACD,SAAKV,gBAAL,GAAwBA,gBAAxB;AACA,SAAKK,UAAL,GAAkBA,UAAlB;AACA,SAAKK,wBAAL,GAAgCA,wBAAhC;AACA,SAAKJ,qBAAL,GAA6BA,qBAA7B;AACA,SAAKF,qBAAL,GAA6BA,qBAA7B;AACA,SAAKH,gBAAL,GAAwBA,gBAAxB;AACA,SAAKC,aAAL,GAAqBA,aAArB;AACA,SAAKS,eAAL,GAAuB,EAAvB;;AAEA,QAAI,CAACR,SAAL,EAAgB;AACd,YAAM,IAAIS,KAAJ,CACJ,6GADI,CAAN;AAGD;AACD,SAAKT,SAAL,GAAiBA,SAAjB;AACD;AACD;;;;;;;;;;sBAOEU,gB,EAA2B;AAAA;;AAC3B,UAAIC,YAAJ;AACA,UAAI,uBAAUD,gBAAV,CAAJ,EAAiC;AAC/BC,cAAM,oBAAOD,gBAAP,EAAyB;AAAA,iBAAK,MAAKE,GAAL,CAASC,CAAT,CAAL;AAAA,SAAzB,CAAN;AACA,YAAI,qBAAQF,GAAR,CAAJ,EAAkB;AAChBA,gBAAM,oBAAOD,gBAAP,CAAN;AACD;AACF,OALD,MAKO;AACLC,cAAMD,gBAAN;AACD;;AAT0B,wCAANI,IAAM;AAANA,YAAM;AAAA;;AAW3B,aAAO,KAAKC,IAAL,cAAUJ,GAAV,SAAkBG,IAAlB,EAAP;AACD;;;yBAGCE,c,EACAC,K,EAOA;AAAA,sFADI,EACJ;AAAA,wCALEhB,qBAKF;AAAA,UALEA,qBAKF,yCAL0B,KAK1B;AAAA,wCAJEiB,iBAIF;AAAA,UAJEA,iBAIF,yCAJsB,KAItB;AAAA,wCAHEC,mBAGF;AAAA,UAHEA,mBAGF,yCAHwB,KAGxB;AAAA,qCAFEC,YAEF;AAAA,UAFEA,YAEF,sCAFiB,4BAEjB;;AACA,UAAI,CAACJ,cAAL,EAAqB;AACnB,eAAOI,YAAP;AACD;AACD,UAAI,CAACD,mBAAD,IAAwB,KAAKjB,UAAL,EAA5B,EAA+C;AAC7C,eAAOc,cAAP;AACD;AACD,UAAMK,cAAc,KAAKxB,gBAAL,CAAsByB,SAAtB,CAClB,KAAKC,SAAL,EADkB,EAElBP,cAFkB,EAGlBC,KAHkB,EAIlBhB,yBAAyB,KAAKA,qBAA9B,GACI,KAAKuB,iBAAL,EADJ,GAEIC,SANc,CAApB;;AASA;AACA,UAAI,CAAC,qBAAQJ,WAAR,CAAL,EAA2B;AACzB,eAAOA,WAAP;AACD,OAFD,MAEO,IAAIH,qBAAqB,KAAKX,wBAAL,EAAzB,EAA0D;AAC/D,eAAOS,cAAP;AACD;AACD,aAAO,IAAP,CAtBA,CAsBY;AACb;;;wBAEGA,c,EAAgB;AAClB,aAAO,KAAKnB,gBAAL,CAAsBe,GAAtB,CAA0BI,cAA1B,CAAP;AACD;;;8BAESA,c,EAAgB;AACxB,aAAO,KAAKnB,gBAAL,CAAsB6B,SAAtB,CAAgCV,cAAhC,CAAP;AACD;;AAED;;;;;;;;yBAMKW,G,EAAyB;AAAA,UAApBC,WAAoB,uEAAN,IAAM;;AAC5B;AACA,UAAMC,OAAO,SAAPA,IAAO;AAAA,eAAWD,cAAiBA,WAAjB,SAAgCE,MAAhC,GAA2CA,MAAtD;AAAA,OAAb;AACA,UAAMC,IAAI,SAAJA,CAAI;AAAA,eAAU,mBAAMJ,GAAN,EAAWE,KAAKC,MAAL,CAAX,CAAV;AAAA,OAAV;;AAEA,UAAMT,cAAcU,EAAE,KAAKR,SAAL,EAAF,CAApB;AACA,UAAI,CAAC,qBAAQF,WAAR,CAAL,EAA2B;AACzB,eAAOA,WAAP;AACD;AACD,UAAMW,iBAAiB,KAAKR,iBAAL,EAAvB;AACA,UAAI,KAAKvB,qBAAL,IAA8B,KAAKsB,SAAL,OAAqBS,cAAvD,EAAuE;AACrE,eAAOD,EAAEC,cAAF,CAAP;AACD;AACD,aAAO,IAAP,CAb4B,CAahB;AACb;;;6BAEQF,M,EAAQ;AACf,aAAO,KAAKhC,gBAAL,CAAsBmC,OAAtB,CAA8BH,MAA9B,MAA0C,CAAC,CAAlD;AACD;;;sCAEiBA,M,EAAQ;AACxB,UAAI,CAACA,MAAL,EAAa;AACX,eAAO,KAAK/B,aAAZ;AACD,OAFD,MAEO,IAAI,KAAKmC,QAAL,CAAcJ,MAAd,CAAJ,EAA2B;AAChC,eAAOA,MAAP;AACD;;AALuB,0BAMTA,OAAOK,KAAP,CAAa,GAAb,CANS;AAAA;AAAA,UAMjBC,IANiB;;AAOxB,UAAI,KAAKF,QAAL,CAAcE,IAAd,CAAJ,EAAyB;AACvB,eAAOA,IAAP;AACD;AACD,aAAO,KAAKrC,aAAZ;AACD;;;8BAES+B,M,EAAQ;AAChB,UAAME,iBAAiB,KAAKR,iBAAL,CAAuBM,MAAvB,CAAvB;AACA,WAAK9B,SAAL,CAAeqC,GAAf,CAAmB,QAAnB,EAA6BL,cAA7B;AACA,WAAKxB,eAAL,CAAqB8B,OAArB,CAA6B;AAAA,eAAYC,SAASP,cAAT,CAAZ;AAAA,OAA7B;AACD;;;gCACW;AACV,aAAO,KAAKR,iBAAL,CAAuB,KAAKxB,SAAL,CAAewC,GAAf,CAAmB,QAAnB,CAAvB,CAAP;AACD;;;0CAEqB;AACpB,aAAO,KAAK1C,gBAAZ;AACD;;;mCAEcyC,Q,EAAU;AACvB,WAAK/B,eAAL,CAAqBiC,IAArB,CAA0BF,QAA1B;AACD;;;;;kBAGY3C,U","file":"i18n_service.js","sourcesContent":["/**\navailable in context as i18n.\n\ni18n.t(key, props): translate the given key (caution: only reactive in tracker-komposer)\n\n**/\nimport _ from 'lodash'\n\nclass I18nClient {\n  constructor({\n    translationStore, // mandatory\n    supportedLocales = ['en'],\n    defaultLocale = 'en',\n    stateDict, // stores current data, because this is designed to be a singleton\n    // whether it should use fallback locale if translation is missing\n    // the rule is the following: xx_XX --> xx --> defaultLocale\n    useFallbackForMissing = true,\n\n    // pass function as isEditMode that uses a reactive data-source\n    // if you do so and it changes to true,\n    // all of your translations will show their keys\n    // also, if you click on one of your translations (via T),\n    // editTranslationAction will be called\n    isEditMode = () => false,\n    editTranslationAction = translationId => {\n      /* eslint no-console: 0*/\n      console.log('define editTranslationAction in I18nConstructor')\n      console.log('you can define a mantra-action (string)')\n      console.log('or you can define a function')\n      console.log(`would edit ${translationId}`)\n    },\n    // shouldShowKeysAsFallback defines whether it should show the keys of translation\n    // if the translation is not available (can also be reactive datasource)\n    // this is usefull for admins and/or in development-environement\n    shouldShowKeysAsFallback = () => false\n  }) {\n    this.translationStore = translationStore\n    this.isEditMode = isEditMode\n    this.shouldShowKeysAsFallback = shouldShowKeysAsFallback\n    this.editTranslationAction = editTranslationAction\n    this.useFallbackForMissing = useFallbackForMissing\n    this.supportedLocales = supportedLocales\n    this.defaultLocale = defaultLocale\n    this.changeCallbacks = []\n\n    if (!stateDict) {\n      throw new Error(\n        'please pass stateDict to i18nstore, which has the set/get like a Map. Usually you use ReactiveDict for that'\n      )\n    }\n    this.stateDict = stateDict\n  }\n  /**\n\n    NEW: if param is an array, it will return the first that exists (in any language)\n    if no key is found, it uses the last key.\n    This is usuefull if you create keys programatically (e.g. by error codes)\n    or by convention and have a certain fallback strategy\n  **/\n  t(keyOrArrayOfKeys, ...args) {\n    let key\n    if (_.isArray(keyOrArrayOfKeys)) {\n      key = _.find(keyOrArrayOfKeys, k => this.has(k))\n      if (_.isNil(key)) {\n        key = _.last(keyOrArrayOfKeys)\n      }\n    } else {\n      key = keyOrArrayOfKeys\n    }\n\n    return this.tKey(key, ...args)\n  }\n\n  tKey(\n    keyOrNamespace,\n    props,\n    {\n      useFallbackForMissing = false,\n      showKeyForMissing = false,\n      disableEditorBypass = false,\n      nullKeyValue = '! no translationId given !'\n    } = {}\n  ) {\n    if (!keyOrNamespace) {\n      return nullKeyValue\n    }\n    if (!disableEditorBypass && this.isEditMode()) {\n      return keyOrNamespace\n    }\n    const translation = this.translationStore.translate(\n      this.getLocale(),\n      keyOrNamespace,\n      props,\n      useFallbackForMissing || this.useFallbackForMissing\n        ? this.getFallbackLocale()\n        : undefined\n    )\n\n    // if still nil and is editor, return key if allowed\n    if (!_.isNil(translation)) {\n      return translation\n    } else if (showKeyForMissing || this.shouldShowKeysAsFallback()) {\n      return keyOrNamespace\n    }\n    return null // we tried :-(\n  }\n\n  has(keyOrNamespace) {\n    return this.translationStore.has(keyOrNamespace)\n  }\n\n  hasObject(keyOrNamespace) {\n    return this.translationStore.hasObject(keyOrNamespace)\n  }\n\n  /**\n    translate a certain property from a document.\n    It will check if the document has doc[propertyKey].de, .fr, etc.\n\n    if propertyKey is not set, it will fetch doc.de, doc.fr, etc.\n  **/\n  tDoc(doc, propertyKey = null) {\n    // closure helpers\n    const path = locale => (propertyKey ? `${propertyKey}.${locale}` : locale)\n    const t = locale => _.get(doc, path(locale))\n\n    const translation = t(this.getLocale())\n    if (!_.isNil(translation)) {\n      return translation\n    }\n    const fallbackLocale = this.getFallbackLocale()\n    if (this.useFallbackForMissing && this.getLocale() !== fallbackLocale) {\n      return t(fallbackLocale)\n    }\n    return null // no key fallback at the moment\n  }\n\n  supports(locale) {\n    return this.supportedLocales.indexOf(locale) !== -1\n  }\n\n  getFallbackLocale(locale) {\n    if (!locale) {\n      return this.defaultLocale\n    } else if (this.supports(locale)) {\n      return locale\n    }\n    const [lang] = locale.split('-')\n    if (this.supports(lang)) {\n      return lang\n    }\n    return this.defaultLocale\n  }\n\n  setLocale(locale) {\n    const fallbackLocale = this.getFallbackLocale(locale)\n    this.stateDict.set('locale', fallbackLocale)\n    this.changeCallbacks.forEach(callback => callback(fallbackLocale))\n  }\n  getLocale() {\n    return this.getFallbackLocale(this.stateDict.get('locale'))\n  }\n\n  getSupportedLocales() {\n    return this.supportedLocales\n  }\n\n  onChangeLocale(callback) {\n    this.changeCallbacks.push(callback)\n  }\n}\n\nexport default I18nClient\n"]}