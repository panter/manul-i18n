{"version":3,"sources":["../../src/stores/collection.js"],"names":["Meteor","ReactiveVar","collection","publicationName","isClient","initClient","initServer","locale","startSubscription","getLocale","subscribe","publish","find","fields","getValueKey","isServer","console","trace","Error","get","set","keyOrNamespace","options","_locale","params","results","findResultsForKey","getValue","entry","_replaceParamsInString","object","_id","length","overwrite","objectOrString","findOne","result","$regex","fetch","string","paramsUnflatted","open","close","replacedString","forEach","param","substitution","split","join"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA;;;;;;;AAIE,oBAKU;AAAA,mFAAJ,EAAI;AAAA,QAJRA,MAIQ,QAJRA,MAIQ;AAAA,QAHRC,WAGQ,QAHRA,WAGQ;AAAA,QAFRC,UAEQ,QAFRA,UAEQ;AAAA,oCADRC,eACQ;AAAA,QADRA,eACQ,wCADU,cACV;;AAAA;;AACR,SAAKA,eAAL,GAAuBA,eAAvB;AACA,SAAKD,UAAL,GAAkBA,UAAlB;AACA,SAAKF,MAAL,GAAcA,MAAd;AACA,SAAKC,WAAL,GAAmBA,WAAnB;AACA,QAAID,OAAOI,QAAX,EAAqB;AACnB,WAAKC,UAAL;AACD,KAFD,MAEO;AACL,WAAKC,UAAL;AACD;AACF;;;;iCAEY;AACX,WAAKC,MAAL,GAAc,IAAI,KAAKN,WAAT,EAAd;AACA,WAAKO,iBAAL,CAAuB,KAAKC,SAAL,EAAvB;AACD;;;sCAEiBF,M,EAAQ;AACxB;AACA,WAAKP,MAAL,CAAYU,SAAZ,CAAsB,KAAKP,eAA3B,EAA4CI,MAA5C;AACD;;;iCAEY;AAAA;;AACX,WAAKP,MAAL,CAAYW,OAAZ,CAAoB,KAAKR,eAAzB,EAA0C;AAAA,eACvC,MAAKD,UAAL,CAAgBU,IAAhB,CAAqB,EAArB,EAAyB,EAAEC,0CAAW,MAAKC,WAAL,CAAiBP,MAAjB,CAAX,EAAsC,IAAtC,CAAF,EAAzB,CADuC;AAAA,OAA1C;AAGD;;;gCAEW;AACV,UAAI,KAAKP,MAAL,CAAYe,QAAhB,EAA0B;AACxBC,gBAAQC,KAAR,CAAc,4FAAd;AACA,cAAM,IAAI,KAAKjB,MAAL,CAAYkB,KAAhB,CAAsB,4CAAtB,CAAN;AACD;AACD,aAAO,KAAKX,MAAL,CAAYY,GAAZ,EAAP;AACD;;;8BAESZ,M,EAAQ;AAChB,UAAI,KAAKP,MAAL,CAAYe,QAAhB,EAA0B;AACxB,cAAM,IAAI,KAAKf,MAAL,CAAYkB,KAAhB,CAAsB,4CAAtB,CAAN;AACD;AACD,WAAKX,MAAL,CAAYa,GAAZ,CAAgBb,MAAhB;AACA,WAAKC,iBAAL,CAAuBD,MAAvB,EALgB,CAKgB;AACjC;AACD;;;;gCACYA,M,EAAQ;AAClB,wBAAgBA,MAAhB;AACD;;;8BAESc,c,EAA8B;AAAA;;AAAA,UAAdC,OAAc,uEAAJ,EAAI;;AAAA,6BACYA,OADZ,CAC9BC,OAD8B;AAAA,UAC9BA,OAD8B,oCACpB,KAAKd,SAAL,EADoB;AAAA,UACCe,MADD,0CACYF,OADZ;AAEtC;AACA;;;AACA,UAAI,KAAKtB,MAAL,CAAYI,QAAZ,IAAwBmB,YAAY,KAAKd,SAAL,EAAxC,EAA0D;AACxD,aAAKD,iBAAL,CAAuBe,OAAvB;AACD;AACD,UAAI,CAACF,cAAL,EAAqB;AACnB,eAAO,EAAP;AACD;;AAED,UAAMI,UAAU,KAAKC,iBAAL,CAAuBL,cAAvB,CAAhB;;AAEA,UAAMM,WAAW,SAAXA,QAAW,CAACC,KAAD,EAAW;AAC1B,YAAI,mBAAMA,KAAN,EAAa,OAAKd,WAAL,CAAiBS,OAAjB,CAAb,CAAJ,EAA6C;AAC3C,iBAAO,OAAKM,sBAAL,CACH,mBAAMD,KAAN,EAAa,OAAKd,WAAL,CAAiBS,OAAjB,CAAb,CADG,EAELC,MAFK,CAAP;AAID;AACD,eAAO,IAAP;AACD,OARD;AASA,UAAMM,SAAS,qBACb,oBACA,sBAAO;AAAA,YAAGC,GAAH,SAAGA,GAAH;AAAA,eAAaA,IAAIC,MAAjB;AAAA,OAAP,CADA,EAEA,qBAAM,KAAN,CAFA,EAGA,yBAAUL,QAAV,CAHA,EAIAF,OAJA,CADa,EAKH,EAAEQ,WAAW,IAAb,EALG,CAAf;AAMA,UAAMC,iBAAiB,mBAAMJ,MAAN,EAAcT,cAAd,CAAvB;AACA,UAAI,CAAC,wBAAWa,cAAX,CAAD,IAA+B,uBAAUA,cAAV,CAAnC,EAA8D;AAC5D;AACA,eAAO,IAAP;AACD;AACD,aAAOA,cAAP;AACD;;;wBAEGb,c,EAAgB;AAClB,aAAO,KAAKnB,UAAL,CAAgBiC,OAAhB,CAAwBd,cAAxB,CAAP;AACD;;;8BACSA,c,EAAgB;AACxB,aAAO,KAAKK,iBAAL,CAAuBL,cAAvB,EAAuCW,MAAvC,GAAgD,CAAvD;AACD;;;sCAEiBX,c,EAAgB;AAChC,UAAMe,SAAS,KAAKlC,UAAL,CAAgBiC,OAAhB,CAAwBd,cAAxB,CAAf;AACA,UAAI,CAACe,MAAL,EAAa;AACX;AACA;AACA,eAAO,KAAKlC,UAAL,CAAgBU,IAAhB,CAAqB,EAAEmB,KAAK,EAAEM,QAAWhB,cAAX,OAAF,EAAP,EAArB,EAAiEiB,KAAjE,EAAP;AACD;AACD,aAAO,CAACF,MAAD,CAAP;AACD;;;2CAEsBG,M,EAAQC,e,EAAiB;AAC9C;AACA,UAAMhB,SAAS,oBAAKgB,eAAL,CAAf;AACA,UAAMC,OAAO,IAAb;AACA,UAAMC,QAAQ,GAAd;AACA,UAAIC,iBAAiBJ,MAArB;AACA,0BAAYf,MAAZ,EAAoBoB,OAApB,CAA4B,UAACC,KAAD,EAAW;AACrC,YAAMC,eAAe,mBAAMtB,MAAN,EAAcqB,KAAd,EAAqB,EAArB,CAArB;AACAF,yBAAiBA,eAAeI,KAAf,CAAqBN,OAAOI,KAAP,GAAeH,KAApC,EAA2CM,IAA3C,CAAgDF,YAAhD,CAAjB;AACD,OAHD;AAIA,aAAOH,cAAP;AACD","file":"collection.js","sourcesContent":["import _ from 'lodash';\nimport { flow, sortBy, keyBy, mapValues } from 'lodash/fp';\n\nimport flat, { unflatten } from 'flat';\n\n\nexport default class {\n  constructor({\n    Meteor,\n    ReactiveVar, // only needed on client\n    collection,\n    publicationName = 'translations',\n    } = {}) {\n    this.publicationName = publicationName;\n    this.collection = collection;\n    this.Meteor = Meteor;\n    this.ReactiveVar = ReactiveVar;\n    if (Meteor.isClient) {\n      this.initClient();\n    } else {\n      this.initServer();\n    }\n  }\n\n  initClient() {\n    this.locale = new this.ReactiveVar();\n    this.startSubscription(this.getLocale());\n  }\n\n  startSubscription(locale) {\n    // we keep all old subscription, so no stop or tracker here\n    this.Meteor.subscribe(this.publicationName, locale);\n  }\n\n  initServer() {\n    this.Meteor.publish(this.publicationName, locale =>\n       this.collection.find({}, { fields: { [this.getValueKey(locale)]: true } }),\n    );\n  }\n\n  getLocale() {\n    if (this.Meteor.isServer) {\n      console.trace('getLocale can only be called on the client, pass _locale to translate if using from server');\n      throw new this.Meteor.Error('getLocale can only be called on the client');\n    }\n    return this.locale.get();\n  }\n\n  setLocale(locale) {\n    if (this.Meteor.isServer) {\n      throw new this.Meteor.Error('setLocale can only be called on the client');\n    }\n    this.locale.set(locale);\n    this.startSubscription(locale); // restart\n  }\n  /* eslint class-methods-use-this: 0*/\n  getValueKey(locale) {\n    return `value_${locale}`;\n  }\n\n  translate(keyOrNamespace, options = {}) {\n    const { _locale = this.getLocale(), ...params } = options;\n    // if locale is different (e.g. fallback), subscribe to that locale as well\n    // so that it will be available soon\n    if (this.Meteor.isClient && _locale !== this.getLocale()) {\n      this.startSubscription(_locale);\n    }\n    if (!keyOrNamespace) {\n      return '';\n    }\n\n    const results = this.findResultsForKey(keyOrNamespace);\n\n    const getValue = (entry) => {\n      if (_.has(entry, this.getValueKey(_locale))) {\n        return this._replaceParamsInString(\n            _.get(entry, this.getValueKey(_locale)),\n          params,\n        );\n      }\n      return null;\n    };\n    const object = unflatten(\n      flow(\n      sortBy(({ _id }) => _id.length),\n      keyBy('_id'),\n      mapValues(getValue),\n    )(results), { overwrite: true });\n    const objectOrString = _.get(object, keyOrNamespace);\n    if (!_.isString(objectOrString) && _.isEmpty(objectOrString)) {\n      // empty object or undefined\n      return null;\n    }\n    return objectOrString;\n  }\n\n  has(keyOrNamespace) {\n    return this.collection.findOne(keyOrNamespace);\n  }\n  hasObject(keyOrNamespace) {\n    return this.findResultsForKey(keyOrNamespace).length > 1;\n  }\n\n  findResultsForKey(keyOrNamespace) {\n    const result = this.collection.findOne(keyOrNamespace);\n    if (!result) {\n      // a parent is requested, find all childs that start with keyOrNamespace\n      // this is slow, so we do it only if there is no exact key\n      return this.collection.find({ _id: { $regex: `${keyOrNamespace}/*` } }).fetch();\n    }\n    return [result];\n  }\n\n  _replaceParamsInString(string, paramsUnflatted) {\n    // flat params if not flat\n    const params = flat(paramsUnflatted);\n    const open = '{$';\n    const close = '}';\n    let replacedString = string;\n    Object.keys(params).forEach((param) => {\n      const substitution = _.get(params, param, '');\n      replacedString = replacedString.split(open + param + close).join(substitution);\n    });\n    return replacedString;\n  }\n\n\n}\n"]}