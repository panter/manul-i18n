{"version":3,"sources":["../../src/stores/collection.js"],"names":["Meteor","Ground","ReactiveVar","collection","publicationName","useMethod","Tracker","Error","isClient","initClient","initServer","isServer","console","trace","locale","get","set","startSubscription","subscriptions","collectionGrounded","Collection","_name","observeSource","find","call","error","translations","usedIds","forEach","_id","translation","getCollection","upsert","$set","push","remove","$nin","nonreactive","subscribe","keep","that","methods","_translations","fields","getValueKey","fetch","publish","publishTranslations","ready","entry","params","_replaceParamsInString","keyOrNamespace","options","_locale","getLocale","entryByKey","_findEntryForKey","_getValue","entries","_findEntriesForNamespace","fullObject","length","overwrite","objectForNamespace","findOne","namespace","findResultsForNamespace","$regex","string","paramsUnflatted","open","close","replacedString","param","substitution","split","join"],"mappings":"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","file":"collection.js","sourcesContent":["import _ from 'lodash';\nimport { flow, sortBy, keyBy, mapValues } from 'lodash/fp';\n\nimport flat, { unflatten } from 'flat';\n\n\nexport default class {\n  constructor({\n    Meteor,\n    Ground, // optional, enables caching via Ground https://github.com/GroundMeteor/\n    ReactiveVar, // only needed on client\n    collection,\n    publicationName = 'translations',\n\n    // set to true if you are experience high loads. Translations will no longer be reactive if true\n    useMethod = false,\n    Tracker,\n    } = {}) {\n    this.Ground = Ground;\n    this.Tracker = Tracker;\n    this.publicationName = publicationName;\n    this.collection = collection;\n    this.Meteor = Meteor;\n    this.ReactiveVar = ReactiveVar;\n    this.useMethod = useMethod;\n    if (this.useMethod && !Ground) {\n      throw new Error('please use ground-collection if using method calls');\n    }\n\n    if (Meteor.isClient) {\n      this.initClient();\n    } else {\n      this.initServer();\n    }\n  }\n\n  getLocale() {\n    if (this.Meteor.isServer) {\n      console.trace('getLocale can only be called on the client, pass _locale to translate if using from server');\n      throw new this.Meteor.Error('getLocale can only be called on the client');\n    }\n    return this.locale.get();\n  }\n\n  setLocale(locale) {\n    if (this.Meteor.isServer) {\n      throw new this.Meteor.Error('setLocale can only be called on the client');\n    }\n    this.locale.set(locale);\n    this.startSubscription(locale); // restart\n  }\n\n  initClient() {\n    this.locale = new this.ReactiveVar();\n    this.subscriptions = {};\n    if (this.Ground) {\n      this.collectionGrounded = new this.Ground.Collection(`${this.collection._name}-grounded`);\n      if (!this.useMethod) {\n        this.collectionGrounded.observeSource(this.collection.find());\n      }\n    }\n  }\n\n\n  startSubscription(locale) {\n    if (!locale || this.subscriptions[locale]) {\n      return; // do not resubscribe;\n    }\n    if (this.useMethod) {\n      this.subscriptions[locale] = true;\n      this.Meteor.call('_translations', locale, (error, translations) => {\n        if (!error) {\n          const usedIds = [];\n          translations.forEach(\n            ({ _id, ...translation }) => {\n              this.getCollection().upsert({ _id }, { $set: translation });\n              usedIds.push(_id);\n            },\n          );\n          this.getCollection().remove({ _id: { $nin: usedIds } });\n        }\n      });\n    } else {\n      this.Tracker.nonreactive(() => {\n      // we keep all old subscription, so no stop or tracker here\n        this.subscriptions[locale] = this.Meteor.subscribe(this.publicationName, locale, () => {\n          if (this.collectionGrounded) {\n          // reset and keep only new ones\n            this.collectionGrounded.keep(this.collection.find());\n          }\n        });\n      });\n    }\n  }\n\n  initServer() {\n    const that = this;\n    this.Meteor.methods({\n      _translations(locale) {\n        return that.collection.find({}, { fields: { [that.getValueKey(locale)]: true } }).fetch();\n      },\n    });\n    this.Meteor.publish(this.publicationName, function publishTranslations(locale) {\n      if (!locale) {\n        this.ready();\n        return null;\n      }\n\n      return that.collection.find({}, { fields: { [that.getValueKey(locale)]: true } });\n    },\n    );\n  }\n\n\n  /* eslint class-methods-use-this: 0*/\n  getValueKey(locale) {\n    return `value_${locale}`;\n  }\n  _getValue(entry, locale, params) {\n    if (_.has(entry, this.getValueKey(locale))) {\n      return this._replaceParamsInString(\n          _.get(entry, this.getValueKey(locale)),\n        params,\n      );\n    }\n    return null;\n  }\n\n  translate(keyOrNamespace, options = {}) {\n    const { _locale = this.getLocale(), ...params } = options;\n    // if locale is different (e.g. fallback), subscribe to that locale as well\n    // so that it will be available soon\n    if (this.Meteor.isClient && _locale !== this.getLocale()) {\n      this.startSubscription(_locale);\n    }\n    if (!keyOrNamespace) {\n      return '';\n    }\n\n    const entryByKey = this._findEntryForKey(keyOrNamespace);\n    if (entryByKey) {\n      return this._getValue(entryByKey, _locale, params);\n    } else if (this.useMethod || this.subscriptions[_locale].ready()) {\n      // try to find for namespace\n      // this is expensive, so we do it only if subscription is ready\n      const entries = this._findEntriesForNamespace(keyOrNamespace);\n      const fullObject = unflatten(\n        flow(\n        sortBy(({ _id }) => _id.length),\n        keyBy('_id'),\n        mapValues(entry => this._getValue(entry, _locale, params)),\n      )(entries), { overwrite: true });\n      const objectForNamespace = _.get(fullObject, keyOrNamespace);\n      if (_.isEmpty(objectForNamespace)) {\n        return null;\n      }\n      return objectForNamespace;\n    }\n    return null;\n  }\n  getCollection() {\n    return this.collectionGrounded || this.collection;\n  }\n  has(keyOrNamespace) {\n    return this.getCollection().findOne(keyOrNamespace);\n  }\n  hasObject(namespace) {\n    return this.findResultsForNamespace(namespace).length > 1;\n  }\n\n\n  /**\n  returns either one or multiple results\n  multiple results means that an namespace was requested\n  **/\n  _findEntryForKey(keyOrNamespace) {\n    return this.getCollection().findOne(keyOrNamespace);\n  }\n\n  _findEntriesForNamespace(namespace) {\n    // console.log('doing expensive fetch', namespace);\n    return this.getCollection().find({ _id: { $regex: `^${namespace}` } }).fetch();\n  }\n\n  _replaceParamsInString(string, paramsUnflatted) {\n    // flat params if not flat\n    const params = flat(paramsUnflatted);\n    const open = '{$';\n    const close = '}';\n    let replacedString = string;\n    Object.keys(params).forEach((param) => {\n      const substitution = _.get(params, param, '');\n      replacedString = replacedString.split(open + param + close).join(substitution);\n    });\n    return replacedString;\n  }\n\n\n}\n"]}